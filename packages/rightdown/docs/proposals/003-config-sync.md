# Configuration Synchronization Proposal

## Overview

Enable Rightdown to synchronize with existing formatter configuration files (`.prettierrc`, `biome.json`, `.editorconfig`) through import/export functionality, creating a unified configuration management system that works seamlessly with native VS Code extensions and AI coding environments.

## Motivation

- **VS Code Integration**: Native extensions expect their own config files
- **AI Coding Environments**: Agents understand standard config formats
- **DRY Principle**: Avoid duplicating configuration across multiple files
- **Team Consistency**: Single source of truth for formatting rules

## Design

### Import Functionality

Import existing formatter configurations into `.rightdown.config.yaml`:

```bash
# Import all found configurations
rightdown import

# Import with merge (preserve existing values)
rightdown import --merge

# Import specific formatter configs
rightdown import --prettier --merge

# Dry run to preview changes
rightdown import --dry-run
```

#### Merge Behavior

With `--merge` flag:
- Existing values in `.rightdown.config.yaml` are preserved
- Only new/missing values are added from external configs
- Comments indicate the source of imported values

#### Example Output

```yaml
# .rightdown.config.yaml after import --merge
version: 2
preset: standard

formatters:
  default: prettier
  languages:
    javascript: biome
    typescript: biome

formatterOptions:
  prettier:
    printWidth: 80              # existing value preserved
    tabWidth: 2                 # imported from .prettierrc.yaml
    semi: false                 # imported from .prettierrc.yaml
    singleQuote: true          # imported from .prettierrc.yaml
    trailingComma: es5         # imported from .prettierrc.yaml
    
  biome:
    indentWidth: 2             # imported from biome.json
    lineWidth: 80              # existing value preserved
    semicolons: asNeeded       # imported from biome.json
```

### Export/Deploy Functionality

Generate tool-specific configuration files from Rightdown config:

```bash
# Deploy all configured formatters
rightdown deploy

# Deploy specific formatter configs
rightdown deploy --prettier --biome

# Dry run to preview files
rightdown deploy --dry-run
```

#### Generated Files

**`.prettierrc.yaml`** (from Rightdown config):
```yaml
# Generated by Rightdown - do not edit directly
# Modify .rightdown.config.yaml and run 'rightdown deploy'
printWidth: 80
tabWidth: 2
semi: false
singleQuote: true
trailingComma: es5
```

**`biome.json`** (from Rightdown config):
```json
{
  "$schema": "https://biomejs.dev/schemas/1.9.4/schema.json",
  "_comment": "Generated by Rightdown - modify .rightdown.config.yaml",
  "formatter": {
    "enabled": true,
    "indentWidth": 2,
    "lineWidth": 80
  },
  "javascript": {
    "formatter": {
      "semicolons": "asNeeded"
    }
  }
}
```

**`.editorconfig`** (from shared settings):
```ini
# Generated by Rightdown
root = true

[*]
end_of_line = lf
trim_trailing_whitespace = true

[*.{js,ts,jsx,tsx}]
indent_style = space
indent_size = 2

[*.md]
max_line_length = 80
```

### Configuration Schema

```yaml
# .rightdown.config.yaml
version: 2
preset: standard

# Sync configuration (optional)
sync:
  # Files to generate on deploy
  deploy:
    - prettier    # Generates .prettierrc.yaml
    - biome      # Generates biome.json
    - editorconfig # Generates .editorconfig
  
  # Prevent overwriting manual changes
  preserveManualEdits: true
  
  # Add warning headers to generated files
  addHeaders: true

# Standard formatter configuration
formatters:
  default: prettier
  languages:
    javascript: biome
    typescript: biome
    json: prettier

# Formatter options (single consolidated section)
formatterOptions:
  prettier:
    printWidth: 80
    tabWidth: 2
    # ... other prettier options
    
  biome:
    indentWidth: 2
    lineWidth: 80
    # ... other biome options

# Shared options (applied when generating .editorconfig)
editorConfig:
  endOfLine: lf
  trimTrailingWhitespace: true
  insertFinalNewline: true
```

### Command Reference

#### Import Commands

```bash
rightdown import [options]

Options:
  --merge              Don't override existing values, only add new ones
  --prettier          Import from Prettier config files
  --biome             Import from Biome config files  
  --editorconfig      Import from .editorconfig
  --all               Import from all found configs (default)
  --dry-run           Preview changes without modifying files
  --output <file>     Output to specific file (default: .rightdown.config.yaml)
```

#### Deploy Commands

```bash
rightdown deploy [options]

Options:
  --prettier          Deploy .prettierrc.yaml
  --biome             Deploy biome.json
  --editorconfig      Deploy .editorconfig
  --all               Deploy all configured targets (default)
  --dry-run           Preview files without writing
  --force             Overwrite existing files without prompting
  --no-headers        Don't add "Generated by Rightdown" headers
```

### Workflow Examples

#### Initial Setup

```bash
# Import existing configurations
rightdown import --merge

# Review .rightdown.config.yaml
cat .rightdown.config.yaml

# Deploy to create tool configs
rightdown deploy
```

#### Updating Configuration

```bash
# Edit the source of truth
vim .rightdown.config.yaml

# Deploy changes to all tools
rightdown deploy

# VS Code extensions immediately use updated configs
```

#### CI/CD Integration

```bash
# Ensure configs are in sync
rightdown deploy --dry-run --check

# Exit with error if configs would change
if [ $? -ne 0 ]; then
  echo "Config files out of sync. Run 'rightdown deploy'"
  exit 1
fi
```

### Implementation Considerations

1. **Parser Support**: Need parsers for:
   - JSON/JSONC (biome.json)
   - YAML (.prettierrc.yaml)
   - INI (.editorconfig)
   - Potentially JS (prettier.config.js) - could skip initially

2. **Config Discovery**: Search order for finding configs:
   - Current directory
   - Parent directories up to git root
   - Home directory (for global configs)

3. **Conflict Resolution**: When importing:
   - Interactive prompts for conflicts (without --merge)
   - Clear reporting of what was imported
   - Ability to preview changes (--dry-run)

4. **Generated File Management**:
   - Clear headers indicating files are generated
   - Option to check if files are in sync
   - Git-friendly (deterministic output)

5. **Validation**: 
   - Validate imported configs
   - Warn about incompatible options
   - Check formatter availability

### Future Enhancements

1. **Watch Mode**: Auto-deploy on config changes
   ```bash
   rightdown sync --watch
   ```

2. **Config Profiles**: Different configs for different contexts
   ```bash
   rightdown deploy --profile production
   ```

3. **Remote Config**: Import from URLs or gists
   ```bash
   rightdown import --from https://company.com/formatter-config.yaml
   ```

4. **Config Diffing**: Show differences between configs
   ```bash
   rightdown diff --prettier
   ```

## Benefits

1. **Single Source of Truth**: One config file to rule them all
2. **Tool Compatibility**: Native extensions work without modification
3. **AI-Friendly**: Standard config files that AI agents understand
4. **Migration Path**: Easy adoption via import functionality
5. **Team Alignment**: Consistent formatting across all tools

## Questions for Discussion

1. Should we support JavaScript config files (requires dynamic import)?
2. How to handle tool-specific options that don't map cleanly?
3. Should deploy be automatic after editing .rightdown.config.yaml?
4. What about configs in package.json (prettier field)?
5. Should we support project-specific vs global configs?