# Formatting Package Simplification - 2025-01-21

## Overview

This document outlines the planned simplification of the @outfitter/formatting package, moving from a complex multi-formatter orchestrator to an opinionated, zero-config setup tool that leverages Ultracite (Biome preset) for TypeScript/JavaScript and Prettier for everything else.

## Current State

The formatting package currently:

- Supports 5 formatters (Prettier, Biome, ESLint, Remark, markdownlint-cli2)
- Has a complex preset system (standard, strict, relaxed)
- Supports YAML preset inheritance
- Manages conflicts between formatters
- Includes a Remark plugin for formatting code blocks
- Tries to be flexible and accommodate many workflows

## Proposed Changes

### 1. Tool Simplification

**Clear separation of responsibilities:**

```yaml
Biome (via Ultracite):
  - All TypeScript/JavaScript/JSX/TSX formatting
  - All TypeScript/JavaScript/JSX/TSX linting
  - ~300 opinionated rules via Ultracite preset
  - No configuration needed

Prettier:
  - YAML, JSON, CSS, HTML formatting
  - Markdown formatting
  - Other non-JS/TS languages
  - Explicitly ignores JS/TS files

markdownlint-cli2:
  - Markdown linting only (not formatting)
  - Complements Prettier's markdown formatting
```

### 2. Remove Complexity

**Items to remove:**

- ‚ùå Preset system (standard/strict/relaxed)
- ‚ùå YAML preset parsing and inheritance
- ‚ùå ESLint generator and support
- ‚ùå Remark generator and support (can add back later if needed)
- ‚ùå Conflict detection between formatters
- ‚ùå Code block formatting plugin
- ‚ùå Most configuration options

### 3. New Architecture

#### Dependencies

```json
{
  "dependencies": {
    "@outfitter/contracts": "workspace:*",
    "ultracite": "^1.0.0",
    "commander": "^12.0.0"
  },
  "peerDependencies": {
    "@biomejs/biome": ">=1.8.0",
    "prettier": ">=3.0.0",
    "markdownlint-cli2": ">=0.10.0"
  }
}
```

#### Core Generators

**Biome Configuration:**

```typescript
export function generateBiomeConfig(): GeneratedConfig {
  return {
    path: 'biome.json',
    content: JSON.stringify({
      "$schema": "https://biomejs.dev/schemas/1.9.4/schema.json",
      "extends": ["ultracite"]
    }, null, 2)
  };
}
```

**Prettier Configuration:**

```typescript
export function generatePrettierConfig(): GeneratedConfig {
  return {
    path: '.prettierrc.json',
    content: JSON.stringify({
      // Prettier should ignore JS/TS files - Biome handles those
      overrides: [
        {
          files: ["*.js", "*.jsx", "*.ts", "*.tsx", "*.mjs", "*.cjs"],
          options: {
            requirePragma: true  // Effectively disables Prettier for these
          }
        }
      ]
    }, null, 2)
  };
}
```

**VS Code Settings:**

```typescript
export function generateVSCodeSettings(): GeneratedConfig {
  return {
    path: '.vscode/settings.json',
    content: JSON.stringify({
      "editor.defaultFormatter": "biomejs.biome",
      "editor.formatOnSave": true,
      "editor.codeActionsOnSave": {
        "quickfix.biome": "explicit",
        "source.organizeImports.biome": "explicit"
      },
      "[javascript]": {
        "editor.defaultFormatter": "biomejs.biome"
      },
      "[typescript]": {
        "editor.defaultFormatter": "biomejs.biome"
      },
      "[javascriptreact]": {
        "editor.defaultFormatter": "biomejs.biome"
      },
      "[typescriptreact]": {
        "editor.defaultFormatter": "biomejs.biome"
      },
      "[json]": {
        "editor.defaultFormatter": "esbenp.prettier-vscode"
      },
      "[jsonc]": {
        "editor.defaultFormatter": "esbenp.prettier-vscode"
      },
      "[yaml]": {
        "editor.defaultFormatter": "esbenp.prettier-vscode"
      },
      "[markdown]": {
        "editor.defaultFormatter": "esbenp.prettier-vscode"
      }
    }, null, 2),
    merge: true  // Merge with existing settings
  };
}
```

**EditorConfig:**

```typescript
export function generateEditorConfig(): GeneratedConfig {
  return {
    path: '.editorconfig',
    content: `# Generated by @outfitter/formatting
root = true

[*]
charset = utf-8
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true
indent_style = space
indent_size = 2

[*.{md,mdx}]
trim_trailing_whitespace = false

[*.{yml,yaml}]
indent_size = 2

[Makefile]
indent_style = tab
`
  };
}
```

### 4. Additional Configurations

**VS Code Extensions Recommendations:**

```json
{
  "recommendations": [
    "biomejs.biome",
    "esbenp.prettier-vscode",
    "davidanson.vscode-markdownlint",
    "editorconfig.editorconfig"
  ]
}
```

**Git Attributes:**

```
* text=auto eol=lf
*.{cmd,[cC][mM][dD]} text eol=crlf
*.{bat,[bB][aA][tT]} text eol=crlf
```

### 5. Simplified Setup API

```typescript
export interface SetupOptions {
  includeMarkdownLint?: boolean;  // Default: true
  includeEditorConfig?: boolean;   // Default: true
  setupVSCode?: boolean;          // Default: true
  dryRun?: boolean;               // Default: false
}

export async function setup(options: SetupOptions = {}): Promise<Result<SetupResult, Error>> {
  // 1. Detect available tools
  // 2. Generate configs (no customization)
  // 3. Smart merge for existing JSON files
  // 4. Update package.json scripts
  // 5. Create supporting files (.editorconfig, .gitattributes)
}
```

### 6. Package.json Scripts

```json
{
  "scripts": {
    "format": "biome check --write .",
    "format:check": "biome check .",
    "lint": "biome lint . && markdownlint-cli2",
    "lint:fix": "biome lint --write . && markdownlint-cli2 --fix",
    "ci": "biome ci .",
    "editor:setup": "outfitter-formatting setup-editor"
  }
}
```

### 7. Smart Config Merging

For existing JSON files like `.vscode/settings.json`, implement deep merge:

- Preserve existing settings
- Override with our formatter settings
- Maintain proper JSON formatting
- Handle comments in JSONC files

### 8. Benefits

1. **Zero Configuration**: Just run setup and get opinionated formatting
2. **No Conflicts**: Each tool has clearly separated responsibilities
3. **Performance**: Biome is 10-100x faster than ESLint/Prettier for JS/TS
4. **Consistency**: Ultracite provides ~300 battle-tested rules
5. **Simplicity**: 80% less code to maintain
6. **Modern**: Uses the latest, fastest tools
7. **AI-Ready**: Ultracite is specifically designed for AI code generation

### 9. Migration Guide

For users upgrading from the current version:

```bash
# 1. Remove old configuration files
rm .eslintrc* .prettierrc* remark.config.* 

# 2. Update dependencies
pnpm remove eslint remark remark-cli
pnpm add -D @outfitter/formatting@next ultracite @biomejs/biome prettier markdownlint-cli2

# 3. Run new setup
npx outfitter-formatting setup

# 4. Update CI/CD scripts to use new commands
# Old: pnpm lint && pnpm format:check
# New: pnpm ci
```

### 10. Future Considerations

- Could add Remark support back if needed for advanced markdown processing
- Could add project templates (Next.js, Vite, etc.) with specific overrides
- Could integrate with GitHub Actions workflow generation
- Could add support for monorepo-specific configurations

## Implementation Plan

1. Create new branch: `feat/formatting-simplification`
2. Remove all preset-related code
3. Remove ESLint and Remark generators
4. Add Ultracite dependency
5. Implement new generators (Biome, Prettier, VS Code, EditorConfig)
6. Implement smart JSON merging for existing files
7. Update tests to reflect new behavior
8. Update documentation
9. Create migration guide
10. Publish as next/beta version for testing

This represents a major version bump (2.0.0) due to breaking changes.

## Alternative Approach: Leverage Ultracite Init

Instead of reimplementing what Ultracite already does well, we could pivot the @outfitter/formatting package to:

### Option 1: Wrapper Around Ultracite Init

```typescript
export async function setup(options: SetupOptions = {}): Promise<Result<SetupResult, Error>> {
  // 1. Run ultracite init first
  await execAsync('npx ultracite init');
  
  // 2. Then add our additional configurations:
  //    - Prettier config for non-JS/TS files
  //    - markdownlint-cli2 setup
  //    - EditorConfig
  //    - Additional VS Code settings
  //    - Git attributes
}
```

### Option 2: Complementary Tool

Position @outfitter/formatting as a tool that complements Ultracite:

1. **Ultracite handles**: Biome setup, VS Code config for JS/TS, basic formatting
2. **@outfitter/formatting adds**:
   - Prettier for non-JS/TS files with proper ignore patterns
   - markdownlint-cli2 configuration
   - EditorConfig for cross-editor consistency
   - Git attributes for line endings
   - Additional VS Code settings for other file types
   - Monorepo-specific configurations

### Option 3: Minimal Package

Make @outfitter/formatting extremely minimal:

```typescript
// Just a thin orchestrator
export async function setup() {
  console.log('Setting up Outfitter formatting...');
  
  // 1. Run ultracite init
  console.log('Initializing Ultracite (Biome) for JS/TS...');
  await execAsync('npx ultracite init');
  
  // 2. Add Prettier for other files
  console.log('Configuring Prettier for non-JS/TS files...');
  await writeFile('.prettierrc.json', prettierConfig);
  
  // 3. Add markdownlint if requested
  console.log('Setting up markdown linting...');
  await writeFile('.markdownlint-cli2.yaml', markdownlintConfig);
  
  // 4. Update package.json scripts to combine tools
  await updatePackageJsonScripts({
    "format": "biome check --write . && prettier --write '**/*.{yml,yaml,json,md,css,html}'",
    "lint": "biome lint . && markdownlint-cli2"
  });
}
```

### Recommendation: Unified Init Command

Implement **Option 2** with our own init command that orchestrates everything:

```typescript
#!/usr/bin/env node
import { execAsync } from 'node:child_process';
import { detectPackageManager } from './utils/detect-pm.js';

export async function init(options: InitOptions = {}): Promise<Result<void, Error>> {
  const pm = detectPackageManager(); // pnpm, npm, yarn, bun
  
  console.log('üöÄ Initializing Outfitter formatting setup...\n');
  
  // Step 1: Run ultracite init
  console.log('üì¶ Setting up Ultracite (Biome) for TypeScript/JavaScript...');
  try {
    await execAsync(`${pm.dlx} ultracite init`);
    console.log('‚úÖ Ultracite initialized successfully\n');
  } catch (error) {
    console.log('‚ùå Failed to initialize Ultracite');
    return failure(error);
  }
  
  // Step 2: Install additional dependencies
  console.log('üì¶ Installing additional formatters...');
  await execAsync(`${pm.install} -D prettier markdownlint-cli2`);
  
  // Step 3: Configure Prettier for non-JS/TS files
  console.log('üé® Configuring Prettier for non-JS/TS files...');
  await writeFile('.prettierrc.json', generatePrettierConfig());
  await writeFile('.prettierignore', generatePrettierIgnore());
  
  // Step 4: Configure markdownlint
  console.log('üìù Setting up markdown linting...');
  await writeFile('.markdownlint-cli2.yaml', generateMarkdownlintConfig());
  
  // Step 5: Add EditorConfig
  console.log('üìù Creating EditorConfig...');
  await writeFile('.editorconfig', generateEditorConfig());
  
  // Step 6: Update VS Code settings for other file types
  console.log('üîß Updating VS Code settings...');
  await mergeVSCodeSettings(generateAdditionalVSCodeSettings());
  
  // Step 7: Add git attributes
  console.log('üìÑ Creating git attributes...');
  await writeFile('.gitattributes', generateGitAttributes());
  
  // Step 8: Update package.json scripts
  console.log('üìú Updating package.json scripts...');
  await updatePackageJsonScripts({
    "format": "biome check --write . && prettier --write '**/*.{yml,yaml,json,md,css,html}'",
    "format:check": "biome check . && prettier --check '**/*.{yml,yaml,json,md,css,html}'",
    "lint": "biome lint . && markdownlint-cli2",
    "lint:fix": "biome lint --write . && markdownlint-cli2 --fix",
    "ci": "biome ci . && prettier --check '**/*.{yml,yaml,json,md,css,html}' && markdownlint-cli2"
  });
  
  console.log('\n‚ú® Outfitter formatting setup complete!');
  console.log('\nRun "pnpm format" to format your code');
  console.log('Run "pnpm lint" to check for issues\n');
}
```

### CLI Usage

```bash
# Single command to set up everything
npx @outfitter/formatting init

# Or with package manager specific commands
pnpm dlx @outfitter/formatting init
bunx @outfitter/formatting init
yarn dlx @outfitter/formatting init
```

### Benefits of This Approach

1. **Single Command**: Users run one command to get a complete formatting setup
2. **Package Manager Aware**: Uses the correct dlx/npx command for their PM
3. **Handles Dependencies**: Installs all needed packages automatically
4. **Clear Progress**: Shows what's happening at each step
5. **Leverages Ultracite**: Gets all the benefits of Ultracite's zero-config Biome setup
6. **Adds Missing Pieces**: Completes the setup with tools Ultracite doesn't handle
7. **Graceful Failures**: If ultracite init fails, we can provide helpful error messages

This makes @outfitter/formatting a true "one-stop shop" for formatting setup while still leveraging the excellent work done by Ultracite.
